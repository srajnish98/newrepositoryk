name: Selenium Auto-Scaling (Fixed Networking)

on:
  workflow_dispatch:
    inputs:
      suite_name:
        description: 'Choose Suite'
        required: true
        type: choice
        options:
          - sanity-suites.xml
          - regression-suites.xml

jobs:
  automation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup K8s (Kind)
        uses: helm/kind-action@v1.10.0
        with:
          version: v0.24.0
          cluster_name: kind

      - name: Calculate Required Nodes
        id: scanner
        run: |
          XML_PATH=$(find . -name "${{ github.event.inputs.suite_name }}" | head -n 1)
          if [ -z "$XML_PATH" ]; then
            echo "nodes=2" >> $GITHUB_OUTPUT
          else
            TEST_COUNT=$(grep -c "<test " $XML_PATH || echo 2)
            [ "$TEST_COUNT" -gt 10 ] && FINAL=10 || FINAL=$TEST_COUNT
            echo "nodes=$FINAL" >> $GITHUB_OUTPUT
          fi

      - name: Deploy Selenium Infrastructure
        run: |
          REPLICAS=${{ steps.scanner.outputs.nodes }}
          cat <<EOF | kubectl apply -f -
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: selenium-hub
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: selenium-hub
            template:
              metadata:
                labels:
                  app: selenium-hub
              spec:
                containers:
                - name: selenium-hub
                  image: selenium/hub:4.16.1
                  ports:
                    - containerPort: 4444
                    - containerPort: 4442
                    - containerPort: 4443
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: selenium-hub
          spec:
            ports:
              - name: hub
                port: 4444
              - name: bus-publish
                port: 4442
              - name: bus-subscribe
                port: 4443
            selector:
              app: selenium-hub
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: selenium-node-chrome
          spec:
            replicas: $REPLICAS
            selector:
              matchLabels:
                app: selenium-node-chrome
            template:
              metadata:
                labels:
                  app: selenium-node-chrome
              spec:
                containers:
                - name: selenium-node-chrome
                  image: selenium/node-chrome:130.0
                  env:
                  - name: SE_EVENT_BUS_HOST
                    value: selenium-hub
                  - name: SE_EVENT_BUS_PUBLISH_PORT
                    value: "4442"
                  - name: SE_EVENT_BUS_SUBSCRIBE_PORT
                    value: "4443"
                  - name: SE_HUB_HOST
                    value: selenium-hub
                  - name: SE_NODE_MAX_SESSIONS
                    value: "1"
                  volumeMounts:
                  - mountPath: /dev/shm
                    name: dshm
                volumes:
                - name: dshm
                  emptyDir: {medium: Memory, sizeLimit: "2Gi"}
          EOF

      - name: Run Automation
        run: |
          echo "Waiting for pods to stabilize..."
          kubectl rollout status deployment/selenium-node-chrome --timeout=180s
          
          echo "Establishing Grid Tunnel..."
          kubectl port-forward service/selenium-hub 4444:4444 > pf.log 2>&1 &
          
          echo "Waiting for Selenium Grid Health API..."
          timeout 120s bash -c 'until curl -s http://localhost:4444/status | grep "\"ready\": true"; do 
            echo "Waiting for nodes to register with Hub..."
            sleep 5
          done' || (
            echo "!!! Registration Failed - Checking Logs !!!"
            kubectl logs -l app=selenium-hub --tail=50
            kubectl logs -l app=selenium-node-chrome --tail=50
            exit 1
          )
          
          mvn test -DsuiteXmlFile=${{ github.event.inputs.suite_name }} \
                   -DthreadCount=${{ steps.scanner.outputs.nodes }} \
                   -Dsurefire.rerunFailingTestsCount=1
        env:
          SELENIUM_REMOTE_URL: http://localhost:4444/wd/hub

      - name: Cleanup
        if: always()
        run: |
          sudo killall kubectl || true
          kind delete cluster --name kind || true
