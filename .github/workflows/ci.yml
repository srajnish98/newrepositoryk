name: Selenium Automation in K8s

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Create K8s Cluster (Kind)
        uses: engineerd/setup-kind@v0.5.0
        with:
          version: "v0.19.0"

      - name: Deploy Selenium Grid to K8s
        run: |
          kubectl apply -f k8s/selenium-grid.yaml
          # Wait for the hub to be ready
          kubectl wait --for=condition=available deployment/selenium-hub --timeout=60s
          kubectl wait --for=condition=available deployment/selenium-node-chrome --timeout=60s

      - name: Port Forward Selenium Hub
        run: |
          # Run in background so the next steps can execute
          kubectl port-forward service/selenium-hub 4444:4444 &
          # Give it a few seconds to establish the tunnel
          sleep 5

      - name: Run Selenium Tests
        run: mvn test
        env:
          # If your code uses environment variables for the URL
          SELENIUM_GRID_URL: http://localhost:4444/wd/hub

      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: target/surefire-reports/
