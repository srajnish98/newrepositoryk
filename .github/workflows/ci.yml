name: Selenium Auto-Scaling (Final Stable)

on:
  workflow_dispatch:
    inputs:
      suite_name:
        description: 'Choose Suite'
        required: true
        type: choice
        options:
          - sanity-suites.xml
          - regression-suites.xml

jobs:
  automation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. NEW STABLE KIND SETUP
      - name: Setup K8s (Kind)
        uses: helm/kind-action@v1.10.0
        with:
          version: v0.24.0
          cluster_name: kind

      # 2. XML SCANNER (Counts <test> tags)
      - name: Calculate Required Nodes
        id: scanner
        run: |
          # Find the XML file path dynamically
          XML_PATH=$(find . -name "${{ github.event.inputs.suite_name }}" | head -n 1)
          if [ -z "$XML_PATH" ]; then
            echo "nodes=2" >> $GITHUB_OUTPUT
            echo "msg=XML not found. Defaulting to 2."
          else
            TEST_COUNT=$(grep -c "<test " $XML_PATH || echo 2)
            # Cap at 10 browsers for stability on 7GB RAM runners
            [ "$TEST_COUNT" -gt 10 ] && FINAL=10 || FINAL=$TEST_COUNT
            echo "nodes=$FINAL" >> $GITHUB_OUTPUT
            echo "msg=Found $TEST_COUNT tests. Scaling to $FINAL nodes."
          fi

      # 3. DEPLOY GRID
      - name: Deploy Selenium
        run: |
          REPLICAS=${{ steps.scanner.outputs.nodes }}
          cat <<EOF | kubectl apply -f -
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: selenium-hub
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: selenium-hub
            template:
              metadata:
                labels:
                  app: selenium-hub
              spec:
                containers:
                - name: selenium-hub
                  image: selenium/hub:4.16.1
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: selenium-hub
          spec:
            ports: [ {port: 4444} ]
            selector: {app: selenium-hub}
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: selenium-node-chrome
          spec:
            replicas: $REPLICAS
            selector:
              matchLabels:
                app: selenium-node-chrome
            template:
              metadata:
                labels:
                  app: selenium-node-chrome
              spec:
                containers:
                - name: selenium-node-chrome
                  image: selenium/node-chrome:130.0
                  env:
                  - name: SE_EVENT_BUS_HOST
                    value: selenium-hub
                  - name: SE_HUB_HOST
                    value: selenium-hub
                  - name: SE_NODE_MAX_SESSIONS
                    value: "1"
                  volumeMounts:
                  - mountPath: /dev/shm
                    name: dshm
                volumes:
                - name: dshm
                  emptyDir: {medium: Memory, sizeLimit: "2Gi"}
          EOF

      # 4. HEALTH CHECK & TEST
      - name: Run Tests
        run: |
          kubectl rollout status deployment/selenium-node-chrome --timeout=120s
          kubectl port-forward service/selenium-hub 4444:4444 > /dev/null 2>&1 &
          
          # Wait for Grid Status "Ready"
          timeout 60s bash -c 'until curl -s http://localhost:4444/status | grep "\"ready\": true"; do sleep 5; done'
          
          mvn test -DsuiteXmlFile=${{ github.event.inputs.suite_name }} \
                   -DthreadCount=${{ steps.scanner.outputs.nodes }} \
                   -Dsurefire.rerunFailingTestsCount=1
        env:
          SELENIUM_REMOTE_URL: http://localhost:4444/wd/hub

      # 5. AUTO-CLEANUP (Always runs)
      - name: Cleanup
        if: always()
        run: |
          sudo killall kubectl || true
          # helm/kind-action creates a cluster named 'kind' by default
          kind delete cluster --name kind || true
