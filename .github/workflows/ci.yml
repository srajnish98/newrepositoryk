name: Selenium Sanity & Regression (Final Version)

on:
  workflow_dispatch:
    inputs:
      suite_name:
        description: 'Choose Suite'
        required: true
        type: choice
        options: [sanity-suites.xml, regression-suites.xml]
      node_count:
        description: 'Parallel Browsers'
        required: true
        default: '10'

jobs:
  automation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Infrastructure
        uses: engineerd/setup-kind@v0.5.0

      - name: Deploy High-Performance Grid
        run: |
          REPLICAS=${{ github.event.inputs.node_count }}
          # (Deployment YAML remains the same as previous step)
          # Ensure SE_NODE_MAX_SESSIONS: 1 and SE_DRAIN_AFTER_SESSION_COUNT: 1 are set

      - name: Port Forward & Live Monitor
        run: |
          kubectl port-forward service/selenium-hub 4444:4444 > /dev/null 2>&1 &
          timeout 60s bash -c 'until curl -s http://localhost:4444/status | grep "\"ready\": true"; do sleep 5; done'
          
          # Background monitoring of Node Busy/Idle status
          (while true; do 
            echo "--- NODE USAGE ---"
            curl -s http://localhost:4444/status | jq -r '.value.nodes[] | "Node \(.id): Busy=\(.slots[0].session != null)"'
            sleep 20
          done) &

      - name: Run Tests with Auto-Retry
        run: |
          mvn test -DsuiteXmlFile=${{ github.event.inputs.suite_name }} \
                   -DthreadCount=${{ github.event.inputs.node_count }} \
                   -Dsurefire.rerunFailingTestsCount=1
        env:
          SELENIUM_REMOTE_URL: http://localhost:4444/wd/hub

      - name: Upload Test Evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: automation-evidence
          path: |
            target/surefire-reports/
            target/screenshots/
          retention-days: 7

      - name: Cleanup
        if: always()
        run: |
          sudo killall kubectl || true
          kind delete cluster --name chart-testing || true
