name: Selenium Kubernetes Automation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      node_count:
        description: 'Number of Chrome Nodes to scale'
        required: true
        default: '2'

jobs:
  automation-testing:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Create Kind Cluster
        uses: engineerd/setup-kind@v0.5.0
        with:
          version: "v0.19.0"

      - name: Deploy Selenium Grid
        run: |
          # Use manual input if provided, else default to 2
          REPLICAS=${{ github.event.inputs.node_count || 2 }}
          echo "Scaling Chrome Nodes to: $REPLICAS"

          cat <<EOF | kubectl apply -f -
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: selenium-hub
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: selenium-hub
            template:
              metadata:
                labels:
                  app: selenium-hub
              spec:
                containers:
                - name: selenium-hub
                  image: selenium/hub:4.16.1
                  ports:
                    - containerPort: 4444
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: selenium-hub
          spec:
            ports:
              - port: 4444
            selector:
              app: selenium-hub
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: selenium-node-chrome
          spec:
            replicas: $REPLICAS
            selector:
              matchLabels:
                app: selenium-node-chrome
            template:
              metadata:
                labels:
                  app: selenium-node-chrome
              spec:
                containers:
                - name: selenium-node-chrome
                  image: selenium/node-chrome:4.16.1
                  env:
                  - name: SE_EVENT_BUS_HOST
                    value: selenium-hub
                  - name: SE_EVENT_BUS_PUBLISH_PORT
                    value: "4442"
                  - name: SE_EVENT_BUS_SUBSCRIBE_PORT
                    value: "4443"
                  # This replaces shm-size and fixes your error
                  volumeMounts:
                  - mountPath: /dev/shm
                    name: dshm
                volumes:
                - name: dshm
                  emptyDir:
                    medium: Memory
          EOF

      - name: Wait for Infrastructure
        run: |
          kubectl wait --for=condition=Ready pod -l app=selenium-hub --timeout=120s
          kubectl rollout status deployment/selenium-node-chrome --timeout=120s
          
      - name: Start Port-Forwarding
        run: |
          # The '&' runs this in the background
          kubectl port-forward service/selenium-hub 4444:4444 > /dev/null 2>&1 &
          
          # Health check loop
          echo "Waiting for Grid to be ready..."
          timeout 60s bash -c 'until curl -s http://localhost:4444/status | grep "\"ready\": true"; do sleep 5; done'
          echo "Grid is Online!"

      - name: Run Maven Tests
        run: mvn test -DthreadCount=${{ github.event.inputs.node_count || 2 }}
        env:
          SELENIUM_REMOTE_URL: http://localhost:4444/wd/hub

      - name: Upload Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: target/surefire-reports/
